/*
 * backbone.canal v0.1.0
 * Copyright 2013, Matt Morgan (@mlmorg)
 * MIT license
 */
(function(){"use strict";var t=this,r=t._,e=t.Backbone,n=e.Router.prototype.constructor,i=e.Router.prototype._extractParameters,a=e.History.prototype.getFragment,o=/(\(.*?)?[:\*]\w+\)?/g,s=/\(.*?[:\*](\w+)\)/,u=/\?.*$/,c=/\+/g,h=/%20/g,p=/[\-{}\[\]+?.,\\\^$|#\s]/g,l=e.Canal={configure:function(t){return r.extend(this.options,t)},options:{deparam:function(t){var e=t.replace(c," ").split("&"),n={};return r.each(e,function(t){var r=t.split("=");n[r[0]]=decodeURIComponent(r[1])}),n},param:function(t){var e=r.map(t,function(t,r){return r+"="+encodeURIComponent(t)});return e.join("&").replace(h,"+")}}};e.Router=e.Router.extend({constructor:function(){return this._routes={},this._named={},n.apply(this,arguments)},route:function(t,n,i){return t=this._storeRoute(t,n),i||(i=this[n]),e.history.route(t,r.bind(function(a){var o=this._extractParameters(t,a),s=[o];r.each(this._getFilters(n,"before"),function(t){t.apply(this,[n].concat(s))}),i&&i.apply(this,s),this.trigger.apply(this,["route:"+n].concat(s)),this.trigger("route",n,s),e.history.trigger("route",this,n,s)},this)),this},url:function(t,e){e=e||{};var n=this._named[t]||[],i=r.keys(e),a=r.find(n,function(t){var e=r.difference(t.parameters,t.optionalParameters),n=r.difference(e,i);return!n.length});return a?this._buildUrl(a.route,e):void 0},go:function(t,e,n){var i=this.url(t,e);if(r.isString(i))return this.navigate(i,r.extend({trigger:!0},n));if(this[t])return this[t](e);throw Error("No method or matching route exists")},_extractParameters:function(t,e){var n={},a=f(e);e=e.replace(a,""),a&&r.extend(n,l.options.deparam(a.substr(1)));var o=this._routes[t].parameters,s=i.call(this,t,e);return s&&r.each(s,function(t,r){var e=o[r]||r;n[e]=t}),n},_getFilters:function(t,e){var n=[];return r.each(this[e],function(e,i){var a=!0;e=e||{},e.only&&(a=!1,e.only=r.isArray(e.only)?e.only:[e.only],r.contains(e.only,t)&&(a=!0)),e.except&&(e.except=r.isArray(e.except)?e.except:[e.except],r.contains(e.except,t)&&(a=!1)),a&&this[i]&&n.push(this[i])},this),n},_storeRoute:function(t,e){var n=t;r.isRegExp(t)||(t=this._routeToRegExp(t));var i=[],a=r.map(n.match(o),function(t){var r=t.match(s);return r?(t=r[1],i.push(t)):t=t.substr(1),t});return this._routes[t]={route:t,url:n!==t?n:void 0,parameters:a,optionalParameters:i},this._named[e]=this._named[e]||[],this._named[e].push(this._routes[t]),this._named[e]=r.sortBy(this._named[e],function(t){return-t.parameters.length}),t},_buildUrl:function(t,e){e=r.clone(e||{}),t=this._routes[t];var n=t.url||"";r.each(t.parameters,function(t){var i=n.match(RegExp("(\\(.*?)?[:\\*]"+t+"\\)?"));if(i){var a=e[t];r.isString(a)?i[1]&&(a=i[1].substring(1)+a):a="",n=n.replace(i[0],a),delete e[t]}});var i=l.options.param(e);return i&&(n+="?"+i),n}}),r.extend(e.History.prototype,{getFragment:function(t,e){var n,i;return r.isString(t)||(this._hasPushState||!this._wantsHashChange||e)&&(n=this.location.search,i=n.replace(p,"\\$&")),t=a.call(this,t,e),n&&!t.match(i)&&(t+=n),t},loadUrl:function(t){var e=this.fragment=this.getFragment(t),n=f(e),i=n?e.replace(n,""):e,a=r.any(this.handlers,function(t){return t.route.test(i)?(t.callback(e),!0):void 0});return a}});var f=function(t){var r=t.match(u);return r?r[0]:void 0}}).call(this);