/*!
 * backbone.canal v0.1.0
 * Copyright 2013, Matt Morgan (@mlmorg)
 * MIT license
 */
(function(){"use strict";var t=this,r=t._,e=t.Backbone,n=e.Router.prototype._extractParameters,i=/[\:\*]\w+/g,o=/\?.*$/,a=/\+/g,s=/%20/g,u=e.Canal={configure:function(t){return r.extend(this.options,t)},options:{deparam:function(t){var e=t.replace(a," ").split("&");return r.tap({},function(t){r.each(e,function(r){var e=r.split("=");t[e[0]]=decodeURIComponent(e[1])})})},param:function(t){var e=r.map(t,function(t,r){return r+"="+encodeURIComponent(t)});return e.join("&").replace(s,"+")}}};r.extend(e.Router.prototype,{route:function(t,n,o){var a=r.map(t.match(i),function(t){return t.substring(1)});return r.isRegExp(t)||(n&&(this._routes=this._routes||{},this._routes[n]=this._routes[n]||[],this._routes[n].push({url:t,names:a}),this._routes[n]=r.sortBy(this._routes[n],function(t){return-t.names.length})),t=this._routeToRegExp(t)),o||(o=this[n]),e.history.route(t,r.bind(function(r,i){var s=this._extractParameters(t,a,r,i),u=[s];o&&o.apply(this,u),this.trigger.apply(this,["route:"+n].concat(u)),this.trigger("route",n,u),e.history.trigger("route",this,n,u)},this)),this},url:function(t,e){var n=this._routes[t];if(e=r.clone(e),n){var i=r.keys(e),o=r.find(n,function(t){var e=r.difference(t.names,i);return!e.length}),a=o.url;r.each(o.names,function(t){var r=RegExp("(\\(\\/)?[:\\*]"+t+"\\)?");a=a.replace(r,e[t]),delete e[t]});var s=u.options.param(e);return s&&(a+="?"+s),a}},go:function(t,e,n){var i=this.url(t,e);return i!==void 0?this.navigate(i,r.extend({trigger:!0},n)):this[t]?this[t](t,e):void 0},_extractParameters:function(t,e,i,o){var a={};o&&r.extend(a,u.options.deparam(o.substring(1)));var s=n(t,i);return s&&r.each(s,function(t,r){var n=e[r]||r;a[n]=t}),a}}),r.extend(e.History.prototype,{loadUrl:function(t){var e=this.fragment=this.getFragment(t),n=e.match(o)||"";n&&(n=n[0],e=e.replace(n,""));var i=r.any(this.handlers,function(t){return t.route.test(e)?(t.callback(e,n),!0):void 0});return i}})}).call(this);