/*!
 * backbone.canal v0.1.0
 * Copyright 2013, Matt Morgan (@mlmorg)
 * MIT license
 */
(function(){"use strict";var t=this,r=t._,e=t.Backbone,n=e.Router.prototype._extractParameters,i=e.History.prototype.getFragment,a=/(\(.*?)?[:\*]\w+\)?/g,o=/\(.*?:(\w+)\)/,s=/\?.*$/,u=/\+/g,h=/%20/g,c=/[\-{}\[\]+?.,\\\^$|#\s]/g,p=e.Canal={configure:function(t){return r.extend(this.options,t)},options:{deparam:function(t){var e=t.replace(u," ").split("&");return r.tap({},function(t){r.each(e,function(r){var e=r.split("=");t[e[0]]=decodeURIComponent(e[1])})})},param:function(t){var e=r.map(t,function(t,r){return r+"="+encodeURIComponent(t)});return e.join("&").replace(h,"+")}}};r.extend(e.Router.prototype,{route:function(t,n,i){var s=[],u=r.map(t.match(a),function(t){var r=t.match(o);return r?(t=r[1],s.push(t)):t=t.substring(1),t});return r.isRegExp(t)||(n&&(this._routes=this._routes||{},this._routes[n]=this._routes[n]||[],this._routes[n].push({url:t,names:u,optionals:s}),this._routes[n]=r.sortBy(this._routes[n],function(t){return-t.names.length})),t=this._routeToRegExp(t)),i||(i=this[n]),e.history.route(t,r.bind(function(r,a){var o=this._extractParameters(t,u,r,a),s=[o];i&&i.apply(this,s),this.trigger.apply(this,["route:"+n].concat(s)),this.trigger("route",n,s),e.history.trigger("route",this,n,s)},this)),this},url:function(t,e){var n=this._routes?this._routes[t]:void 0;if(n){e=r.clone(e)||{};var i=r.keys(e),a=r.find(n,function(t){var e=r.difference(t.names,t.optionals),n=r.difference(e,i);return!n.length});if(a){var o=a.url;r.each(a.names,function(t){var n=RegExp("(\\(.*?)?[:\\*]"+t+"\\)?"),i=o.match(n);if(i){var a=e[t];r.isString(a)?i[1]&&(a=i[1].substring(1)+a):a="",o=o.replace(i[0],a),delete e[t]}});var s=p.options.param(e);return s&&(o+="?"+s),o}}},go:function(t,e,n){var i=this.url(t,e);if(r.isString(i))return this.navigate(i,r.extend({trigger:!0},n));if(this[t])return this[t](e);throw Error("No method or matching route exists")},_extractParameters:function(t,e,i,a){var o={};a&&r.extend(o,p.options.deparam(a.substring(1)));var s=n.call(this,t,i);return s&&r.each(s,function(t,r){var n=e[r]||r;o[n]=t}),o}}),r.extend(e.History.prototype,{getFragment:function(t,r){if(t=i.call(this,t,r),this._hasPushState||!this._wantsHashChange||r){var e=this.location.search,n=e.replace(c,"\\$&");t.match(n)||(t+=e)}return t},loadUrl:function(t){var e=this.fragment=this.getFragment(t),n=e.match(s)||"";n&&(n=n[0],e=e.replace(n,""));var i=r.any(this.handlers,function(t){return t.route.test(e)?(t.callback(e,n),!0):void 0});return i}})}).call(this);