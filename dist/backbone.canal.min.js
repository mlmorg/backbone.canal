/*!
 * backbone.canal v0.1.0
 * Copyright 2013, Matt Morgan (@mlmorg)
 * MIT license
 */
(function(){"use strict";var t=this,r=t._,e=t.Backbone,n=e.Router.prototype._extractParameters,o=/[\:\*]\w+/g,i=/\?.*$/,a=/\+/g,s=/%20/g,u=e.Canal={configure:function(t){return r.extend(this.options,t)},options:{deparam:function(t){var e=t.replace(a," ").split("&"),n={};return r.each(e,function(t){var r=t.split("=");n[r[0]]=decodeURIComponent(r[1])}),n},param:function(t){var e=r.map(t,function(t,r){return r+"="+encodeURIComponent(t)});return e.join("&").replace(s,"+")}}};r.extend(e.Router.prototype,{route:function(t,n,i){if(!r.isRegExp(t)){var a=r.map(t.match(o),function(t){return t.substring(1)});n&&(this._routes=this._routes||{},this._routes[n]=this._routes[n]||[],this._routes[n].push({url:t,names:a}),this._routes[n]=r.sortBy(this._routes[n],function(t){return-t.names.length})),t=this._routeToRegExp(t)}return i||(i=this[n]),e.history.route(t,r.bind(function(r,o){var s=this._extractParameters(t,a,r,o),u=[s];i&&i.apply(this,u),this.trigger.apply(this,["route:"+n].concat(u)),this.trigger("route",n,u),e.history.trigger("route",this,n,u)},this)),this},url:function(t,e){var n=this._routes[t];if(e=r.clone(e),n){var o=r.keys(e),i=r.find(n,function(t){var e=r.difference(t.names,o);return!e.length}),a=i.url;r.each(i.names,function(t){var r=RegExp("(\\(\\/)?[:\\*]"+t+"\\)?");a=a.replace(r,e[t]),delete e[t]});var s=u.options.param(e);return s&&(a+="?"+s),a}},_extractParameters:function(t,e,o,i){var a={};i&&r.extend(a,u.options.deparam(i.substring(1)));var s=n(t,o);return s&&r.each(s,function(t,r){a[e[r]]=t}),a}}),r.extend(e.History.prototype,{loadUrl:function(t){var e=this.fragment=this.getFragment(t),n=e.match(i)||"";n&&(n=n[0],e=e.replace(n,""));var o=r.any(this.handlers,function(t){return t.route.test(e)?(t.callback(e,n),!0):void 0});return o}})}).call(this);